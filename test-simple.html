<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST SEMPLICE - Calendario Eventi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #000; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #calendar { min-height: 500px; background: white; border-radius: 4px; padding: 1rem; border: 2px solid #ddd; }
        .data-display { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª TEST SEMPLICE - Calendario Eventi</h1>
        <p>Versione semplificata per testare la visualizzazione degli eventi</p>
        
        <div class="test-section">
            <h3>ğŸ¯ Test Rapidi</h3>
            <button class="btn" onclick="testEventiSemplici()">Test Eventi Semplici</button>
            <button class="btn btn-success" onclick="testMercatini()">Test Mercatini Reali</button>
            <button class="btn btn-warning" onclick="testFiere()">Test Fiere Reali</button>
            <button class="btn" onclick="pulisciCalendario()">Pulisci Calendario</button>
            <button class="btn" onclick="mostraEventiCalendario()">Mostra Eventi Calendario</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š Status</h3>
            <div id="status" class="status info">In attesa di test...</div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“… Calendario di Test</h3>
            <div id="calendar"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ Dati Caricati</h3>
            <div class="row">
                <div class="col">
                    <h4>ğŸ›’ Mercatini</h4>
                    <div id="mercatiniData" class="data-display">Nessun dato</div>
                </div>
                <div class="col">
                    <h4>ğŸª Fiere</h4>
                    <div id="fiereData" class="data-display">Nessun dato</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ Log Completo</h3>
            <div id="logData" class="data-display">Log vuoto</div>
        </div>
    </div>
    
    <!-- FullCalendar CSS e JS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        let calendar;
        let mercatini = [];
        let fiere = [];
        
        function log(message) {
            const logEl = document.getElementById('logData');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateDataDisplay(elementId, data) {
            const element = document.getElementById(elementId);
            if (Array.isArray(data)) {
                element.textContent = JSON.stringify(data.slice(0, 3), null, 2);
            } else {
                element.textContent = data;
            }
        }
        
        // Inizializza calendario
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ Inizializzazione calendario...');
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'it',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },
                height: 'auto',
                eventClick: function(info) {
                    log(`ğŸ¯ Click su evento: ${info.event.title}`);
                    alert(`Evento: ${info.event.title}\nData: ${info.event.start.toLocaleDateString('it-IT')}`);
                },
                eventDidMount: function(info) {
                    log(`âœ… Evento montato: ${info.event.title} - ${info.event.start.toISOString().split('T')[0]}`);
                }
            });
            
            calendar.render();
            log('âœ… Calendario inizializzato e renderizzato');
            updateStatus('Calendario pronto per i test', 'success');
        });
        
        function testEventiSemplici() {
            log('ğŸ§ª Test eventi semplici...');
            
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            // Pulisci calendario
            calendar.removeAllEvents();
            log('ğŸ—‘ï¸ Calendario pulito');
            
            // Aggiungi eventi di test
            const oggi = new Date();
            const domani = new Date(oggi);
            domani.setDate(oggi.getDate() + 1);
            const dopodomani = new Date(oggi);
            dopodomani.setDate(oggi.getDate() + 2);
            
            const eventiTest = [
                {
                    title: 'ğŸ§ª Test Evento Oggi',
                    start: oggi,
                    end: oggi,
                    backgroundColor: '#28a745',
                    borderColor: '#28a745'
                },
                {
                    title: 'ğŸ§ª Test Evento Domani',
                    start: domani,
                    end: domani,
                    backgroundColor: '#007bff',
                    borderColor: '#007bff'
                },
                {
                    title: 'ğŸ§ª Test Evento Dopodomani',
                    start: dopodomani,
                    end: dopodomani,
                    backgroundColor: '#ffc107',
                    borderColor: '#ffc107',
                    textColor: '#000'
                }
            ];
            
            eventiTest.forEach(evento => {
                calendar.addEvent(evento);
                log(`â• Aggiunto evento: ${evento.title} - ${evento.start.toISOString().split('T')[0]}`);
            });
            
            log(`âœ… Test completato: ${eventiTest.length} eventi aggiunti`);
            updateStatus(`Test completato: ${eventiTest.length} eventi di test aggiunti`, 'success');
        }
        
        async function testMercatini() {
            log('ğŸ›’ Test mercatini reali...');
            updateStatus('Caricamento mercatini...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1dGB3f47TrT_dVz5PsICci4JuoTWRBQAcPuXjDIYSE58/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                const data = await response.text();
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        mercatini = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`âœ… Mercatini caricati: ${mercatini.length}`);
                        
                        updateDataDisplay('mercatiniData', mercatini);
                        
                        // Aggiungi al calendario
                        aggiungiMercatiniAlCalendario();
                        
                    },
                    error: (error) => {
                        log(`âŒ Errore parsing mercatini: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`âŒ Errore caricamento mercatini: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiMercatiniAlCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            log('ğŸ”„ Aggiunta mercatini al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            mercatini.slice(0, 10).forEach((mercatino, index) => {
                log(`ğŸ” Processando mercatino ${index + 1}: ${mercatino.Comune} - ${mercatino.Giorno}`);
                
                // Genera date per i prossimi 3 mesi
                const date = generaDateMercatino(mercatino.Giorno, anno, 3);
                
                if (date && date.length > 0) {
                    date.forEach(dataSingola => {
                        const evento = {
                            title: `ğŸ›’ ${mercatino.Comune}`,
                            start: dataSingola,
                            end: dataSingola,
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: {
                                tipo: 'mercatino',
                                dati: mercatino
                            }
                        };
                        
                        calendar.addEvent(evento);
                        eventiAggiunti++;
                        log(`â• Aggiunto evento: ${mercatino.Comune} - ${dataSingola}`);
                    });
                }
            });
            
            log(`âœ… Mercatini aggiunti: ${eventiAggiunti} eventi totali`);
            updateStatus(`Mercatini aggiunti: ${eventiAggiunti} eventi`, 'success');
        }
        
        function generaDateMercatino(giorno, anno, mesi) {
            if (!giorno) return null;
            
            const date = [];
            const dataInizio = new Date(anno, 0, 1);
            let data = new Date(dataInizio);
            
            // Determina il giorno della settimana
            let giornoSettimana = -1;
            if (giorno.includes('domenica')) giornoSettimana = 0;
            else if (giorno.includes('lunedÃ¬') || giorno.includes('lunedi')) giornoSettimana = 1;
            else if (giorno.includes('martedÃ¬') || giorno.includes('martedi')) giornoSettimana = 2;
            else if (giorno.includes('mercoledÃ¬') || giorno.includes('mercoledi')) giornoSettimana = 3;
            else if (giorno.includes('giovedÃ¬') || giorno.includes('giovedi')) giornoSettimana = 4;
            else if (giorno.includes('venerdÃ¬') || giorno.includes('venerdi')) giornoSettimana = 5;
            else if (giorno.includes('sabato')) giornoSettimana = 6;
            
            if (giornoSettimana === -1) {
                log(`âŒ Giorno non riconosciuto: ${giorno}`);
                return null;
            }
            
            // Trova il primo giorno della settimana
            while (data.getDay() !== giornoSettimana) {
                data.setDate(data.getDate() + 1);
            }
            
            // Genera date per i mesi specificati
            const dataFine = new Date(anno, mesi, 0);
            while (data <= dataFine) {
                date.push(data.toISOString().split('T')[0]);
                data.setDate(data.getDate() + 7);
            }
            
            log(`ğŸ“… Generate ${date.length} date per ${giorno} nei prossimi ${mesi} mesi`);
            return date;
        }
        
        async function testFiere() {
            log('ğŸª Test fiere reali...');
            updateStatus('Caricamento fiere...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1oa6pz7U79YyD8hey2lANS-x6nMCHnaKBC2LtEIsMyTQ/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                const data = await response.text();
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        fiere = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`âœ… Fiere caricate: ${fiere.length}`);
                        
                        updateDataDisplay('fiereData', fiere);
                        
                        // Aggiungi al calendario
                        aggiungiFiereAlCalendario();
                        
                    },
                    error: (error) => {
                        log(`âŒ Errore parsing fiere: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`âŒ Errore caricamento fiere: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiFiereAlCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            log('ğŸ”„ Aggiunta fiere al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            fiere.slice(0, 10).forEach((fiera, index) => {
                log(`ğŸ” Processando fiera ${index + 1}: ${fiera.Comune} - ${fiera['Data inizio']}`);
                
                const date = generaDataFiera(fiera['Data inizio'], anno);
                
                if (date) {
                    const evento = {
                        title: `ğŸª ${fiera.Denominazione || fiera.Comune}`,
                        start: date,
                        end: date,
                        backgroundColor: '#ffc107',
                        borderColor: '#ffc107',
                        textColor: '#000',
                        extendedProps: {
                            tipo: 'fiera',
                            dati: fiera
                        }
                    };
                    
                    calendar.addEvent(evento);
                    eventiAggiunti++;
                    log(`â• Aggiunta fiera: ${fiera.Denominazione || fiera.Comune} - ${date}`);
                }
            });
            
            log(`âœ… Fiere aggiunte: ${eventiAggiunti} eventi totali`);
            updateStatus(`Fiere aggiunte: ${eventiAggiunti} eventi`, 'success');
        }
        
        function generaDataFiera(dataInizio, anno) {
            if (!dataInizio) return null;
            
            // Prendi solo la prima data se ce ne sono multiple
            const primaData = dataInizio.split('\n')[0].trim();
            
            // Gestisci formato DD/MM
            if (primaData.includes('/')) {
                const [giorno, mese] = primaData.split('/');
                const data = new Date(anno, parseInt(mese) - 1, parseInt(giorno));
                
                // Verifica che la data sia nel futuro
                if (data >= new Date()) {
                    return data.toISOString().split('T')[0];
                }
            }
            
            return null;
        }
        
        function pulisciCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            calendar.removeAllEvents();
            log('ğŸ—‘ï¸ Calendario pulito');
            updateStatus('Calendario pulito', 'success');
        }
        
        function mostraEventiCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            const eventi = calendar.getEvents();
            log(`ğŸ“Š Eventi nel calendario: ${eventi.length}`);
            
            eventi.forEach((evento, index) => {
                log(`ğŸ“… Evento ${index + 1}: ${evento.title} - ${evento.start.toISOString().split('T')[0]}`);
            });
            
            updateStatus(`Eventi nel calendario: ${eventi.length}`, 'info');
        }
        
        // Inizializzazione
        log('ğŸš€ Test semplice inizializzato');
        log('ğŸ“± Usa i pulsanti per testare il calendario');
    </script>
</body>
</html>
