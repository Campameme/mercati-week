<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG - Calendario Eventi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-section h3 { margin-top: 0; color: #333; }
        .data-display { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› DEBUG - Calendario Eventi</h1>
        <p>Versione semplificata per identificare problemi di caricamento dati</p>
        
        <div class="debug-section">
            <h3>ğŸ¯ Controlli Rapidi</h3>
            <button class="btn" onclick="testMercatini()">Test Mercatini CSV</button>
            <button class="btn" onclick="testFiere()">Test Fiere CSV</button>
            <button class="btn" onclick="testParsing()">Test Parsing Completo</button>
            <button class="btn" onclick="clearLogs()">Pulisci Log</button>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“Š Status</h3>
            <div id="status" class="status info">In attesa di test...</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ›’ Mercatini (40 righe attese)</h3>
            <div id="mercatiniData" class="data-display">Nessun dato caricato</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸª Fiere (150 righe attese)</h3>
            <div id="fiereData" class="data-display">Nessun dato caricato</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ˜ï¸ Comuni Trovati</h3>
            <div id="comuniData" class="data-display">Nessun comune trovato</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ·ï¸ Categorie Trovate</h3>
            <div id="categorieData" class="data-display">Nessuna categoria trovata</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“ Log Completo</h3>
            <div id="logData" class="data-display">Log vuoto</div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        let mercatini = [];
        let fiere = [];
        let comuni = new Set();
        let categorie = new Set();
        
        function log(message) {
            const logEl = document.getElementById('logData');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateDataDisplay(elementId, data) {
            const element = document.getElementById(elementId);
            if (Array.isArray(data)) {
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                element.textContent = data;
            }
        }
        
        async function testMercatini() {
            log('ğŸ›’ Test caricamento mercatini...');
            updateStatus('Caricamento mercatini...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1dGB3f47TrT_dVz5PsICci4JuoTWRBQAcPuXjDIYSE58/gviz/tq?tqx=out:csv&sheet=Foglio1';
                log(`ğŸ“¡ URL: ${url}`);
                
                const response = await fetch(url);
                log(`ğŸ“¥ Status: ${response.status} - ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`ğŸ“Š Dati ricevuti: ${data.length} caratteri`);
                log(`ğŸ“‹ Prima riga: ${data.split('\n')[0]}`);
                log(`ğŸ“‹ Seconda riga: ${data.split('\n')[1]}`);
                
                // Test parsing con virgola
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`âœ… Parsing completato: ${results.data.length} righe`);
                        log(`ğŸ·ï¸ Colonne: ${Object.keys(results.data[0] || {}).join(', ')}`);
                        
                        if (results.data.length > 0) {
                            log(`ğŸ” Prima riga parsata: ${JSON.stringify(results.data[0])}`);
                        }
                        
                        mercatini = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`ğŸ¯ Mercatini validi: ${mercatini.length}`);
                        
                        if (mercatini.length > 0) {
                            log(`ğŸ“ Primo mercatino: ${mercatini[0].Comune} - ${mercatini[0].Giorno}`);
                        }
                        
                        updateDataDisplay('mercatiniData', mercatini.slice(0, 5));
                        updateStatus(`Mercatini caricati: ${mercatini.length}`, 'success');
                        
                        // Estrai comuni e categorie
                        extractComuniCategorie();
                    },
                    error: (error) => {
                        log(`âŒ Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`âŒ Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        async function testFiere() {
            log('ğŸª Test caricamento fiere...');
            updateStatus('Caricamento fiere...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1oa6pz7U79YyD8hey2lANS-x6nMCHnaKBC2LtEIsMyTQ/gviz/tq?tqx=out:csv&sheet=Foglio1';
                log(`ğŸ“¡ URL: ${url}`);
                
                const response = await fetch(url);
                log(`ğŸ“¥ Status: ${response.status} - ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`ğŸ“Š Dati ricevuti: ${data.length} caratteri`);
                log(`ğŸ“‹ Prima riga: ${data.split('\n')[0]}`);
                log(`ğŸ“‹ Seconda riga: ${data.split('\n')[1]}`);
                
                // Test parsing con virgola
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`âœ… Parsing completato: ${results.data.length} righe`);
                        log(`ğŸ·ï¸ Colonne: ${Object.keys(results.data[0] || {}).join(', ')}`);
                        
                        if (results.data.length > 0) {
                            log(`ğŸ” Prima riga parsata: ${JSON.stringify(results.data[0])}`);
                        }
                        
                        fiere = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`ğŸ¯ Fiere valide: ${fiere.length}`);
                        
                        if (fiere.length > 0) {
                            log(`ğŸ“ Prima fiera: ${fiere[0].Comune} - ${fiere[0].Denominazione || 'N/A'}`);
                        }
                        
                        updateDataDisplay('fiereData', fiere.slice(0, 5));
                        updateStatus(`Fiere caricate: ${fiere.length}`, 'success');
                        
                        // Estrai comuni e categorie
                        extractComuniCategorie();
                    },
                    error: (error) => {
                        log(`âŒ Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`âŒ Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function extractComuniCategorie() {
            log('ğŸ” Estrazione comuni e categorie...');
            
            // Pulisci i set
            comuni.clear();
            categorie.clear();
            
            // Estrai da mercatini
            mercatini.forEach((mercatino, index) => {
                if (mercatino.Comune) {
                    const comune = mercatino.Comune.trim();
                    comuni.add(comune);
                    log(`ğŸ˜ï¸ Comune mercatino ${index}: "${comune}"`);
                }
                
                if (mercatino["Settori merceologici"]) {
                    const settori = mercatino["Settori merceologici"].split('/');
                    settori.forEach(settore => {
                        const settorePulito = settore.trim();
                        if (settorePulito) {
                            categorie.add(settorePulito);
                            log(`ğŸ·ï¸ Categoria mercatino: "${settorePulito}"`);
                        }
                    });
                }
            });
            
            // Estrai da fiere
            fiere.forEach((fiera, index) => {
                if (fiera.Comune) {
                    const comune = fiera.Comune.trim();
                    comuni.add(comune);
                    log(`ğŸ˜ï¸ Comune fiera ${index}: "${comune}"`);
                }
                
                if (fiera["Settori merceologici"]) {
                    const settori = fiera["Settori merceologici"].split('/');
                    settori.forEach(settore => {
                        const settorePulito = settore.trim();
                        if (settorePulito) {
                            categorie.add(settorePulito);
                            log(`ğŸ·ï¸ Categoria fiera: "${settorePulito}"`);
                        }
                    });
                }
            });
            
            log(`âœ… Estrazione completata: ${comuni.size} comuni, ${categorie.size} categorie`);
            
            // Aggiorna display
            updateDataDisplay('comuniData', Array.from(comuni).sort());
            updateDataDisplay('categorieData', Array.from(categorie).sort());
            
            updateStatus(`Completato: ${comuni.size} comuni, ${categorie.size} categorie`, 'success');
        }
        
        async function testParsing() {
            log('ğŸš€ Test parsing completo...');
            updateStatus('Test completo in corso...', 'info');
            
            await testMercatini();
            await testFiere();
            
            log('âœ… Test completo completato');
        }
        
        function clearLogs() {
            document.getElementById('logData').innerHTML = 'Log pulito\n';
            updateStatus('Log pulito', 'info');
        }
        
        // Inizializzazione
        log('ğŸš€ Debug version inizializzata');
        log('ğŸ“± Usa i pulsanti per testare il caricamento dati');
    </script>
</body>
</html>
