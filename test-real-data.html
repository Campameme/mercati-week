<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST DATI REALI - Carica Google Sheets</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; text-align: center; }
        .btn { padding: 12px 24px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.8; }
        #calendar { min-height: 500px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #007bff; margin: 20px 0; }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; font-weight: bold; text-align: center; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .log { background: #000; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .info { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .data-panel { background: #e9ecef; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .data-item { background: white; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #28a745; }
        .data-item.fiera { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š TEST DATI REALI - Carica Google Sheets</h1>
            <p>Versione che carica i tuoi dati reali e li mostra nel calendario</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="caricaMercatini()">ğŸ›’ Carica Mercatini</button>
            <button class="btn btn-warning" onclick="caricaFiere()">ğŸª Carica Fiere</button>
            <button class="btn btn-success" onclick="caricaTutto()">ğŸš€ Carica Tutto</button>
            <button class="btn btn-danger" onclick="pulisciCalendario()">ğŸ—‘ï¸ Pulisci</button>
            <button class="btn btn-primary" onclick="mostraEventi()">ğŸ“Š Mostra Eventi</button>
        </div>
        
        <div id="status" class="status info">Pronto per caricare i tuoi dati</div>
        
        <div id="calendar"></div>
        
        <div class="data-panel">
            <h4>ğŸ“‹ Dati Caricati</h4>
            <div id="datiCaricati">Nessun dato caricato</div>
        </div>
        
        <div class="info">
            <h4>ğŸ“Š Statistiche</h4>
            <div id="statistiche">Nessuna statistica</div>
        </div>
        
        <div class="info">
            <h4>ğŸ“ Log Completo</h4>
            <div id="log" class="log">Sistema inizializzato...</div>
        </div>
    </div>
    
    <!-- FullCalendar e PapaParse -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        let calendar;
        let mercatini = [];
        let fiere = [];
        
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateDatiCaricati() {
            const datiEl = document.getElementById('datiCaricati');
            let html = '';
            
            if (mercatini.length > 0) {
                html += `<h5>ğŸ›’ Mercatini (${mercatini.length})</h5>`;
                mercatini.slice(0, 3).forEach((item, index) => {
                    html += `<div class="data-item">${index + 1}. ${item.Comune} - ${item.Giorno}</div>`;
                });
                if (mercatini.length > 3) {
                    html += `<div class="data-item">... e altri ${mercatini.length - 3} mercatini</div>`;
                }
            }
            
            if (fiere.length > 0) {
                html += `<h5>ğŸª Fiere (${fiere.length})</h5>`;
                fiere.slice(0, 3).forEach((item, index) => {
                    html += `<div class="data-item fiera">${index + 1}. ${item.Comune} - ${item['Data inizio'] || 'N/A'}</div>`;
                });
                if (fiere.length > 3) {
                    html += `<div class="data-item fiera">... e altri ${fiere.length - 3} fiere</div>`;
                }
            }
            
            if (html === '') {
                html = '<p class="text-muted">Nessun dato caricato</p>';
            }
            
            datiEl.innerHTML = html;
        }
        
        function updateStatistiche() {
            const eventi = calendar ? calendar.getEvents() : [];
            const mercatiniEventi = eventi.filter(e => e.extendedProps.tipo === 'mercatino');
            const fiereEventi = eventi.filter(e => e.extendedProps.tipo === 'fiera');
            
            const statsEl = document.getElementById('statistiche');
            statsEl.innerHTML = `
                <strong>ğŸ“Š Statistiche:</strong><br>
                Dati mercatini: ${mercatini.length}<br>
                Dati fiere: ${fiere.length}<br>
                Eventi calendario: ${eventi.length}<br>
                Eventi mercatini: ${mercatiniEventi.length}<br>
                Eventi fiere: ${fiereEventi.length}
            `;
        }
        
        // Inizializza calendario
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ Inizializzazione calendario...');
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'it',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,listWeek'
                },
                buttonText: {
                    today: 'Oggi',
                    month: 'Mese',
                    week: 'Settimana',
                    list: 'Lista'
                },
                height: 'auto',
                eventClick: function(info) {
                    log(`ğŸ¯ Click su evento: ${info.event.title}`);
                    alert(`Evento: ${info.event.title}\nData: ${info.event.start.toLocaleDateString('it-IT')}\nTipo: ${info.event.extendedProps.tipo || 'N/A'}`);
                },
                eventDidMount: function(info) {
                    log(`âœ… Evento montato: ${info.event.title} - ${info.event.start.toISOString().split('T')[0]}`);
                    updateStatistiche();
                }
            });
            
            calendar.render();
            log('âœ… Calendario inizializzato e renderizzato');
            updateStatus('Calendario pronto per i tuoi dati', 'success');
        });
        
        async function caricaMercatini() {
            log('ğŸ›’ Caricamento mercatini...');
            updateStatus('Caricamento mercatini da Google Sheets...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1dGB3f47TrT_dVz5PsICci4JuoTWRBQAcPuXjDIYSE58/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`ğŸ“Š Dati mercatini ricevuti: ${data.length} caratteri`);
                log(`ğŸ” Primi 200 caratteri: ${data.substring(0, 200)}`);
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`âœ… Parsing completato: ${results.data.length} righe`);
                        log(`ğŸ” Prima riga:`, results.data[0]);
                        log(`ğŸ” Colonne disponibili:`, Object.keys(results.data[0]));
                        
                        mercatini = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`ğŸ¯ Mercatini validi: ${mercatini.length}`);
                        
                        if (mercatini.length > 0) {
                            log(`ğŸ” Primo mercatino:`, mercatini[0]);
                        }
                        
                        updateDatiCaricati();
                        updateStatus(`Mercatini caricati: ${mercatini.length}`, 'success');
                        
                        // Aggiungi al calendario
                        aggiungiMercatiniAlCalendario();
                        
                    },
                    error: (error) => {
                        log(`âŒ Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`âŒ Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiMercatiniAlCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            log('ğŸ”„ Aggiunta mercatini al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            // Processa solo i primi 10 mercatini per performance
            mercatini.slice(0, 10).forEach((mercatino, index) => {
                log(`ğŸ” Processando mercatino ${index + 1}: ${mercatino.Comune} - ${mercatino.Giorno}`);
                
                const date = generaDateMercatino(mercatino.Giorno, anno, 3);
                
                if (date && date.length > 0) {
                    date.forEach(dataSingola => {
                        try {
                            const evento = {
                                title: `ğŸ›’ ${mercatino.Comune}`,
                                start: dataSingola,
                                end: dataSingola,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                extendedProps: {
                                    tipo: 'mercatino',
                                    comune: mercatino.Comune,
                                    giorno: mercatino.Giorno,
                                    orario: mercatino.Orario || 'N/A',
                                    luogo: mercatino['Luogo di svolgimento'] || 'N/A'
                                }
                            };
                            
                            calendar.addEvent(evento);
                            eventiAggiunti++;
                            log(`â• Aggiunto mercatino: ${mercatino.Comune} - ${dataSingola}`);
                            
                        } catch (error) {
                            log(`âŒ Errore aggiunta mercatino: ${error.message}`);
                        }
                    });
                }
            });
            
            log(`âœ… Mercatini aggiunti: ${eventiAggiunti} eventi totali`);
            updateStatus(`Mercatini aggiunti: ${eventiAggiunti} eventi`, 'success');
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('ğŸ”„ Calendario refresh forzato');
                updateStatistiche();
            }, 100);
        }
        
        function generaDateMercatino(giorno, anno, mesi) {
            if (!giorno) return null;
            
            const date = [];
            const dataInizio = new Date(anno, 0, 1);
            let data = new Date(dataInizio);
            
            // Determina il giorno della settimana
            let giornoSettimana = -1;
            if (giorno.includes('domenica')) giornoSettimana = 0;
            else if (giorno.includes('lunedÃ¬') || giorno.includes('lunedi') || giorno.includes('LunedÃ¬') || giorno.includes('Lunedi')) giornoSettimana = 1;
            else if (giorno.includes('martedÃ¬') || giorno.includes('martedi') || giorno.includes('MartedÃ¬') || giorno.includes('Martedi')) giornoSettimana = 2;
            else if (giorno.includes('mercoledÃ¬') || giorno.includes('mercoledi') || giorno.includes('MercoledÃ¬') || giorno.includes('Mercoledi')) giornoSettimana = 3;
            else if (giorno.includes('giovedÃ¬') || giorno.includes('giovedi') || giorno.includes('GiovedÃ¬') || giorno.includes('Giovedi')) giornoSettimana = 4;
            else if (giorno.includes('venerdÃ¬') || giorno.includes('venerdi') || giorno.includes('VenerdÃ¬') || giorno.includes('Venerdi')) giornoSettimana = 5;
            else if (giorno.includes('sabato') || giorno.includes('Sabato')) giornoSettimana = 6;
            
            if (giornoSettimana === -1) {
                log(`âŒ Giorno non riconosciuto: ${giorno}`);
                return null;
            }
            
            // Trova il primo giorno della settimana
            while (data.getDay() !== giornoSettimana) {
                data.setDate(data.getDate() + 1);
            }
            
            // Genera date per i mesi specificati
            const dataFine = new Date(anno, mesi, 0);
            while (data <= dataFine) {
                date.push(data.toISOString().split('T')[0]);
                data.setDate(data.getDate() + 7);
            }
            
            log(`ğŸ“… Generate ${date.length} date per ${giorno} nei prossimi ${mesi} mesi`);
            return date;
        }
        
        async function caricaFiere() {
            log('ğŸª Caricamento fiere...');
            updateStatus('Caricamento fiere da Google Sheets...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1oa6pz7U79YyD8hey2lANS-x6nMCHnaKBC2LtEIsMyTQ/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`ğŸ“Š Dati fiere ricevuti: ${data.length} caratteri`);
                log(`ğŸ” Primi 200 caratteri: ${data.substring(0, 200)}`);
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`âœ… Parsing completato: ${results.data.length} righe`);
                        log(`ğŸ” Prima riga:`, results.data[0]);
                        log(`ğŸ” Colonne disponibili:`, Object.keys(results.data[0]));
                        
                        fiere = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`ğŸ¯ Fiere valide: ${fiere.length}`);
                        
                        if (fiere.length > 0) {
                            log(`ğŸ” Prima fiera:`, fiere[0]);
                        }
                        
                        updateDatiCaricati();
                        updateStatus(`Fiere caricate: ${fiere.length}`, 'success');
                        
                        // Aggiungi al calendario
                        aggiungiFiereAlCalendario();
                        
                    },
                    error: (error) => {
                        log(`âŒ Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`âŒ Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiFiereAlCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            log('ğŸ”„ Aggiunta fiere al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            // Processa solo le prime 10 fiere per performance
            fiere.slice(0, 10).forEach((fiera, index) => {
                log(`ğŸ” Processando fiera ${index + 1}: ${fiera.Comune} - ${fiera['Data inizio']}`);
                
                const date = generaDataFiera(fiera['Data inizio'], anno);
                
                if (date) {
                    try {
                        const evento = {
                            title: `ğŸª ${fiera.Denominazione || fiera.Comune}`,
                            start: date,
                            end: date,
                            backgroundColor: '#ffc107',
                            borderColor: '#ffc107',
                            textColor: '#000',
                            extendedProps: {
                                tipo: 'fiera',
                                comune: fiera.Comune,
                                denominazione: fiera.Denominazione || 'N/A',
                                mese: fiera.Mese || 'N/A',
                                luogo: fiera['Luogo di svolgimento'] || 'N/A'
                            }
                        };
                        
                        calendar.addEvent(evento);
                        eventiAggiunti++;
                        log(`â• Aggiunta fiera: ${fiera.Denominazione || fiera.Comune} - ${date}`);
                        
                    } catch (error) {
                        log(`âŒ Errore aggiunta fiera: ${error.message}`);
                    }
                }
            });
            
            log(`âœ… Fiere aggiunte: ${eventiAggiunti} eventi totali`);
            updateStatus(`Fiere aggiunte: ${eventiAggiunti} eventi`, 'success');
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('ğŸ”„ Calendario refresh forzato');
                updateStatistiche();
            }, 100);
        }
        
        function generaDataFiera(dataInizio, anno) {
            if (!dataInizio) return null;
            
            log(`ğŸ” Creando data fiera per: "${dataInizio}"`);
            
            // Prendi solo la prima data se ce ne sono multiple
            const primaData = dataInizio.split('\n')[0].trim();
            
            // Gestisci formato DD/MM
            if (primaData.includes('/')) {
                const [giorno, mese] = primaData.split('/');
                const data = new Date(anno, parseInt(mese) - 1, parseInt(giorno));
                
                // Verifica che la data sia nel futuro
                if (data >= new Date()) {
                    log(`âœ… Data fiera generata: ${data.toISOString().split('T')[0]}`);
                    return data.toISOString().split('T')[0];
                } else {
                    log(`âš ï¸ Data fiera nel passato: ${data.toISOString().split('T')[0]}`);
                    return null;
                }
            }
            
            // Gestisci formato "dal DD.MM.YYYY al DD.MM.YYYY"
            if (primaData.includes('dal') && primaData.includes('al')) {
                const match = primaData.match(/dal (\d+)\.(\d+)\.(\d+) al (\d+)\.(\d+)\.(\d+)/);
                if (match) {
                    const [, giornoInizio, meseInizio, annoInizio, giornoFine, meseFine, annoFine] = match;
                    const dataInizio = new Date(parseInt(annoInizio), parseInt(meseInizio) - 1, parseInt(giornoInizio));
                    
                    if (dataInizio >= new Date()) {
                        log(`âœ… Data fiera range generata: ${dataInizio.toISOString().split('T')[0]}`);
                        return dataInizio.toISOString().split('T')[0];
                    }
                }
            }
            
            // Gestisci formato "DD.MM.YYYY"
            if (primaData.includes('.') && primaData.includes('2025')) {
                const match = primaData.match(/(\d+)\.(\d+)\.(\d+)/);
                if (match) {
                    const [, giorno, mese, anno] = match;
                    const data = new Date(parseInt(anno), parseInt(mese) - 1, parseInt(giorno));
                    
                    if (data >= new Date()) {
                        log(`âœ… Data fiera punto generata: ${data.toISOString().split('T')[0]}`);
                        return data.toISOString().split('T')[0];
                    }
                }
            }
            
            log(`âŒ Formato data fiera non riconosciuto: "${dataInizio}"`);
            return null;
        }
        
        async function caricaTutto() {
            log('ğŸš€ Caricamento completo...');
            updateStatus('Caricamento completo in corso...', 'info');
            
            await caricaMercatini();
            await caricaFiere();
            
            updateStatus('Caricamento completo completato', 'success');
        }
        
        function pulisciCalendario() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            calendar.removeAllEvents();
            log('ğŸ—‘ï¸ Calendario pulito');
            updateStatus('Calendario pulito', 'success');
            updateStatistiche();
        }
        
        function mostraEventi() {
            if (!calendar) {
                log('âŒ Calendario non inizializzato');
                return;
            }
            
            const eventi = calendar.getEvents();
            log(`ğŸ“Š Eventi nel calendario: ${eventi.length}`);
            
            eventi.forEach((evento, index) => {
                log(`ğŸ“… Evento ${index + 1}: ${evento.title} - ${evento.start.toISOString().split('T')[0]}`);
            });
            
            updateStatus(`Eventi nel calendario: ${eventi.length}`, 'info');
            updateStatistiche();
        }
        
        // Inizializzazione
        log('ğŸš€ Sistema test dati reali inizializzato');
        log('ğŸ“± Usa i pulsanti per caricare i tuoi dati');
    </script>
</body>
</html>
